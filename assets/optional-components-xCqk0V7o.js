var et=Object.defineProperty;var ot=(e,t,o)=>t in e?et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var N=(e,t,o)=>ot(e,typeof t!="symbol"?t+"":t,o);import{ao as rt,an as at,aG as nt,aN as it,a8 as st}from"./maps-DQlQjAlI.js";import{G as ct,a as dt,b as lt,g as J,T as q,c as ut}from"./core-components-BXSE5O8L.js";import{P as M}from"./utils-DvkBdQn9.js";import{b as ft,a as pt}from"./ui-BKNfdvBf.js";var ht=ft();const v=pt(ht);let b;function L(){return new Promise((e,t)=>{const o=indexedDB.open("AvatarDB",1);o.onupgradeneeded=function(a){b=a.target.result,b.objectStoreNames.contains("avatars")||b.createObjectStore("avatars",{keyPath:"id"})},o.onsuccess=function(a){b=a.target.result,e(b)},o.onerror=function(a){t(`Error al abrir IndexedDB: ${a.target.errorCode}`)}})}function z(e){return new Promise((t,o)=>{const i=b.transaction(["avatars"],"readwrite").objectStore("avatars").put(e);i.onsuccess=function(){t("Avatar guardado/actualizado en IndexedDB")},i.onerror=function(f){o(`Error al guardar el avatar: ${f.target.errorCode}`)}})}function W(e){return new Promise((t,o)=>{if(!b){o("IndexedDB is not initialized");return}const i=b.transaction(["avatars"],"readonly").objectStore("avatars").get(e);i.onsuccess=function(f){t(f.target.result)},i.onerror=function(f){o(`Error al obtener el avatar: ${f.target.errorCode}`)}})}function Y(){return new Promise((e,t)=>{if(!b){t("IndexedDB is not initialized");return}const c=b.transaction(["avatars"],"readonly").objectStore("avatars").getAll();c.onsuccess=function(i){e(i.target.result)},c.onerror=function(i){t(`Error al obtener los avatares: ${i.target.errorCode}`)}})}const w=class w{constructor(t,o,a,c,i,f=null,s=Date.now(),p=[]){this.id=t,this.coordinates=o,this.fleet=a,this.avatar=c,this.userId=i,this.previousCoordinates=f,this.direction=this.calculateDirection(),this.speed=this.calculateSpeed(),this.lastTimeUpdate=s,this.history=p.length?p:[{coordinates:[...o],timestamp:s}],this.history.length>w.HISTORY_LIMIT&&(this.history=this.history.slice(-1e3))}calculateDirection(){if(!this.previousCoordinates)return{dx:0,dy:0};const t=this.coordinates[1]*Math.PI/180,o=this.coordinates[0]*Math.PI/180,a=this.previousCoordinates[1]*Math.PI/180,c=this.previousCoordinates[0]*Math.PI/180,i=6371e3,f=a-t,s=c-o,p=i*s*Math.cos((t+a)/2),h=i*f;return{dx:p,dy:h}}calculateSpeed(){if(!this.previousCoordinates)return 0;const t=this.coordinates[1]*Math.PI/180,o=this.coordinates[0]*Math.PI/180,a=this.previousCoordinates[1]*Math.PI/180,c=this.previousCoordinates[0]*Math.PI/180,i=6371e3,f=a-t,s=c-o,p=Math.sin(f/2)*Math.sin(f/2)+Math.cos(t)*Math.cos(a)*Math.sin(s/2)*Math.sin(s/2),h=2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p));return i*h}updateCoordinates(t){this.calculateDistance(t)>=w.MIN_ADVANCE_DISTANCE&&(this.previousCoordinates=[...this.coordinates],this.coordinates=t,this.direction=this.calculateDirection(),this.speed=this.calculateSpeed(),this.lastTimeUpdate=Date.now(),this.history.push({coordinates:[...t],timestamp:this.lastTimeUpdate}),this.history.length>w.HISTORY_LIMIT&&(this.history=this.history.slice(-1e3)))}setHistory(t){Array.isArray(t)&&(t.length>w.HISTORY_LIMIT?this.history=t.slice(-1e3):this.history=t)}calculateDistance(t){const o=this.coordinates[1]*Math.PI/180,a=this.coordinates[0]*Math.PI/180,c=t[1]*Math.PI/180,i=t[0]*Math.PI/180,f=6371e3,s=c-o,p=i-a,h=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o)*Math.cos(c)*Math.sin(p/2)*Math.sin(p/2),x=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));return f*x}};N(w,"HISTORY_LIMIT",1e3),N(w,"MIN_ADVANCE_DISTANCE",5);let T=w;async function gt(e,t){await L();const o=await W(e);if(o){const a=new T(o.id,o.coordinates,o.fleet,o.avatar,o.userId,o.previousCoordinates,o.lastTimeUpdate,o.history||[]);a.updateCoordinates(t.coordinates),await z(a)}else{const a=new T(e,t.coordinates,t.fleet,t.avatar,t.userId,null,Date.now(),[]);await z(a)}}async function B(e){await L();const t=await W(e);if(t)return new T(t.id,t.coordinates,t.fleet,t.avatar,t.userId,t.previousCoordinates,t.lastTimeUpdate,t.history||[]);throw new Error(`Avatar with ID ${e} not found`)}function vt(e){return new Promise((t,o)=>{if(!b){o("IndexedDB is not initialized");return}const i=b.transaction(["avatars"],"readwrite").objectStore("avatars").delete(e);i.onsuccess=function(){t(`Avatar with ID ${e} deleted from IndexedDB`)},i.onerror=function(f){o(`Error deleting avatar: ${f.target.errorCode}`)}})}function R(){return new Promise((e,t)=>{if(!b){t("IndexedDB is not initialized");return}const c=b.transaction(["avatars"],"readwrite").objectStore("avatars").clear();c.onsuccess=function(){e("All avatars deleted from IndexedDB")},c.onerror=function(i){t(`Error clearing avatars: ${i.target.errorCode}`)}})}async function _(e){await L(),setInterval(async()=>{try{const t=await Y(),o=Date.now();e.innerHTML="",t.forEach(a=>{const c=document.createElement("avatar-component");c.setAttribute("img-src",a.avatar),c.setAttribute("title",a.userId),c.setAttribute("subtitle",mt(a.lastTimeUpdate,o)),c.setAttribute("id",a.id),e.appendChild(c)})}catch(t){console.error("Error creating item container:",t)}},3e3)}function mt(e,t){const o=Math.abs(t-e),a=Math.floor(o/(1e3*60*60*24)),c=Math.floor(o%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(o%(1e3*60*60)/(1e3*60)),f=Math.floor(o%(1e3*60)/1e3);return`${a}d ${c}h ${i}m ${f}s`}const O="",yt="v2.0.0",Dt=e=>{if(console.log("Componente SSE version: ",yt),console.log("load componente SSE: ",O),document.title="Sistema de Monitoreo en Tiempo Real",!e){console.error("No se recibió una instancia de mapa válida");return}function t(){const l=document.getElementById("avatarContainer"),n=document.getElementById("avatarContainerList");l&&n?(console.log("Avatar container encontrado, inicializando..."),_(n)):(console.error("Avatar container no encontrado"),o())}function o(){if(document.getElementById("avatarContainer"))return;document.body.insertAdjacentHTML("beforeend",`
            <side-panel id="avatarContainer">
                <div id="db-actions" style="padding-bottom: 8px; display: flex; gap: 8px; border-bottom: 1px solid #aaa; justify-content: space-between;">
                    <button id="exportBtn">Exportar BD</button>
                    <button id="importBtn">Importar BD</button>
                    <input type="file" id="importInput" accept="application/json" style="display:none;">
                </div>
                <div id="avatarContainerList"></div>
            </side-panel>
        `);const r=document.getElementById("avatarContainerList");r&&_(r)}t();function a(){const l=localStorage.getItem("avatar_coords_init");if(l)try{const r=JSON.parse(l);if(Array.isArray(r)&&r.length>=2){const u={longitud:r[0],latitud:r[1],zoom:12};M.publish("initialView",u)}}catch(r){console.error("Error parsing avatar_coords_init from localStorage:",r)}const n=document.getElementById("avatarContainerList");n&&_(n)}a();const c=new ct(e,{title:"avatares"}),i=new dt(e,{title:"geofences"}),f=new lt(e,{title:"historicos"});let s=J(e,"SSE");s.getLayers().push(c.layer),s.getLayers().push(i.layer),s.getLayers().push(f.layer),i.setSource(`${O}/geofences/get`);const p=new EventSource(`${O}/sse`);p.onmessage=function(l){const n=JSON.parse(l.data);let r={},u={};switch(n.command){case"set":r=i.mapGeoFences[n.hook],r!=null&&(n.detect=="enter"||n.detect=="cross"?(i.incrementUserCount(n.hook),r.setStyle(i.getStyleByHook("enter"))):(i.decrementUserCount(n.hook),i.getFeatureCount(n.hook)==0&&r.setStyle(i.getStyleByHook("default"))));const g=n.id;B(g).then(d=>{n.userId=d.userId,bt(n)}).catch(d=>{console.error("Error retrieving avatar:",d)});break;case"avatar":if(u=n.data,c.clearFeatures(),u==null)return;u.forEach(d=>{const D="avatar_coords_init";if(!localStorage.getItem(D)){localStorage.setItem(D,JSON.stringify(d.object.coordinates));const S=d.object.coordinates;if(Array.isArray(S)&&S.length>=2){const tt={longitud:S[0],latitud:S[1],zoom:12};M.publish("initialView",tt)}}const k="avatar",Z="assets/hacker.png",K="unknown",$=j(d,"fleet")+1,P=j(d,"icon")+1,F=j(d,"user_id")+1;let C={};C.x=d.object.coordinates[0],C.y=d.object.coordinates[1],C.uniqueid=d.id;const G=$!==0&&d.fields[$]!==void 0?d.fields[$]:k,H=P!==0&&d.fields[P]!==void 0?d.fields[P]:Z,U=F!==0&&d.fields[F]!==void 0?d.fields[F]:K;C.fleet=G,C.avatar=H,C.userId=U,c.addFeature(C);let Q=d.id;const X={id:d.id,coordinates:d.object.coordinates,fleet:G,avatar:H,userId:U};gt(Q,X).then(()=>{}).catch(S=>{console.error("Error adding or updating avatar:",S)})});break;case"del":console.log(`Del Event: ${JSON.stringify(n)}`);break;default:console.log(JSON.stringify(n))}},p.onerror=function(l){console.error("SSE Error:",l)},window.addEventListener("beforeunload",function(){p.close()}),document.addEventListener("avatar-click",l=>{const n=l.detail.id;B(n).then(r=>{console.log(r);const u=Date.now();Math.abs(r.lastTimeUpdate-u);const g=new rt({geometry:new at(nt(r.coordinates)),unique_id:r.id,fleet:r.fleet,avatar:r.avatar,userId:r.userId});M.publish("featureSelected",g)}).catch(r=>{console.error("Error retrieving avatar:",r)})});const h=V(async l=>{try{const r=(await B(l)).userId||`Avatar ${l}`;(await v.fire({title:"¿Eliminar avatar?",text:`¿Estás seguro de que deseas eliminar "${r}" de la base de datos?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6"})).isConfirmed&&(await vt(l),console.log(`Avatar with ID ${l} deleted from IndexedDB`),v.fire({title:"¡Eliminado!",text:`"${r}" ha sido eliminado de la base de datos.`,icon:"success",timer:2e3,showConfirmButton:!1}))}catch(n){console.error("Error deleting avatar:",n),v.fire({title:"Error",text:"No se pudo eliminar el avatar. Inténtalo de nuevo.",icon:"error",confirmButtonText:"Aceptar"})}},300);document.addEventListener("clear-click",l=>{const n=l.detail.id;h(n)}),document.addEventListener("avatar-history-click",l=>{const n=l.detail.id;B(n).then(r=>{if(f.clearFeatures(),r.history&&r.history.length>1){f.addTrajectory(r.history,"#3C64E9");const u=f.layer.getSource();if(u.getFeatures().length>0){const d=u.getExtent();e.getView().fit(d,{duration:800,maxZoom:17,padding:[45,45,45,45]})}}else v.fire({title:"No hay historial disponible",text:"Este avatar no tiene historial de ubicaciones.",icon:"info",confirmButtonText:"Aceptar"})}).catch(r=>{console.error("Error retrieving avatar history:",r)})});const x=V(()=>{v.fire({title:"¿Estás seguro?",text:"Esta acción eliminará todos los avatares de la base de datos.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar",cancelButtonText:"Cancelar"}).then(l=>{l.isConfirmed&&R().then(()=>{console.log("All avatars deleted from IndexedDB"),c.clearFeatures(),v.fire("¡Eliminado!","La base de datos ha sido borrada.","success")}).catch(n=>{console.error("Error clearing avatars:",n),v.fire("Error","No se pudo borrar la base de datos.","error")})})},500);document.addEventListener("flushdb-click",x);const y=document.getElementById("exportBtn");y&&y.addEventListener("click",async()=>{if((await v.fire({title:"¿Exportar la base de datos?",text:"Esto descargará todos los avatares en un archivo JSON.",icon:"question",showCancelButton:!0,confirmButtonText:"Exportar",cancelButtonText:"Cancelar"})).isConfirmed){await L();const n=await Y(),r=JSON.stringify(n,null,2),u=new Blob([r],{type:"application/json"}),g=URL.createObjectURL(u),d=document.createElement("a");d.href=g,d.download="avatars_export.json",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(g),v.fire("Exportado","Archivo exportado correctamente.","success")}});const m=document.getElementById("importBtn");m&&m.addEventListener("click",async()=>{if((await v.fire({title:"¿Importar base de datos?",text:"Esto puede sobrescribir los avatares actuales. ¿Desea continuar?",icon:"warning",showCancelButton:!0,confirmButtonText:"Importar",cancelButtonText:"Cancelar"})).isConfirmed){const n=document.getElementById("importInput");n&&n.click()}});const E=document.getElementById("importInput");E&&E.addEventListener("change",async l=>{const n=l.target.files[0];if(n)try{const r=await n.text(),u=JSON.parse(r);if(Array.isArray(u)){await L(),await R();for(const g of u)await z(g);v.fire("Importado","Base de datos importada correctamente.","success")}else v.fire("Error","El archivo no contiene un array válido.","error")}catch(r){v.fire("Error","No se pudo importar el archivo: "+r,"error")}}),e.on("click",function(l){e.forEachFeatureAtPixel(l.pixel,function(n,r){if(r===c.layer||r===i.layer){let u=n.getProperties();delete u.geometry,u.layerName=r.get("title"),M.publish("feedbackParent",{type:"sseEventClicked",body:u}),r===i.layer&&(console.log("Geofence clicked:",u),q({text:`Geofence clicked: ${u.Name}`,duration:3e3,close:!0,gravity:"top",position:"center",style:{background:A("#00b09b","#96c93d"),position:"absolute",zIndex:"1000"}}).showToast()),r===c.layer&&B(u.unique_id).then(g=>{const d=`${g.coordinates[1]},${g.coordinates[0]}`;navigator.clipboard.writeText(d).then(function(){console.log("Coordinates copied to clipboard:",d),q({text:`Coordenadas copiadas: ${d}`,duration:3e3,close:!0,gravity:"top",position:"center",style:{background:A("#00b09b","#96c93d"),position:"absolute",zIndex:"1000"}}).showToast()}).catch(function(D){console.error("Could not copy coordinates:",D)})}).catch(g=>{console.error("Error retrieving avatar:",g)})}})}),e.on("moveend",function(l){const r=e.getView().getCenter();if(r){const[u,g]=it(r);localStorage.setItem("avatar_coords_init",JSON.stringify([u,g]))}});class I extends st{constructor(n={}){const r=document.createElement("button");r.innerHTML="👤",r.title="Centrar en avatares";const u=document.createElement("div");u.className="ol-unselectable ol-control ol-center-avatars";const g=window.innerWidth<=768;u.style.top=g?"90px":"80px",u.style.left="0.5em",u.appendChild(r),super({element:u,target:n.target}),r.addEventListener("click",()=>{const d=c.layer.getSource();if(d&&d.getFeatures().length>0){const k=d.getExtent();e.getView().fit(k,{duration:800,maxZoom:17,padding:[40,40,40,40]})}}),window.addEventListener("resize",()=>{const d=window.innerWidth<=768;u.style.top=d?"90px":"80px"})}}e.addControl(new I)};function bt(e){let t={...e},o="right",a="#00b09b",c="#96c93d",i=A(a,c);switch(t.detect){case"enter":t.detect="Entró",o="left";break;case"exit":t.detect="Salió",o="left",a="#ff5f6d",c="#ffc371",i=A(a,c);break;case"cross":t.detect="Cruzó",o="left";break;default:t.detect="Desconocido"}q({text:`${t.userId} - ${t.detect} - ${t.hook}`,duration:15e3,close:!0,gravity:"bottom",position:o,style:{background:i,position:"absolute",zIndex:"1000"}}).showToast()}function A(e,t){return`linear-gradient(to right, ${e}, ${t})`}function j(e,t){return e&&e.fields&&Array.isArray(e.fields)?e.fields.indexOf(t):-1}function V(e,t){let o=null;return function(...a){o&&clearTimeout(o),o=setTimeout(()=>e.apply(this,a),t)}}const xt="v1.0.0",Bt=e=>{if(console.log("Componente DragDrop version: ",xt),console.log("Componente DragDrop iniciado"),!e){console.error("No se recibió una instancia de mapa válida");return}const t=new ut(e,{title:"tematico"});J(e,"DragDrop").getLayers().push(t.layer);const a=e.getTargetElement();a.addEventListener("dragover",s=>{s.preventDefault(),s.dataTransfer.dropEffect="copy",a.style.backgroundColor="rgba(0, 255, 0, 0.1)"}),a.addEventListener("dragleave",s=>{s.preventDefault(),a.style.backgroundColor=""}),a.addEventListener("drop",async s=>{s.preventDefault(),a.style.backgroundColor="";const h=Array.from(s.dataTransfer.files).filter(m=>m.type==="application/json"||m.name.toLowerCase().endsWith(".geojson")||m.name.toLowerCase().endsWith(".json"));if(h.length===0){v.fire({title:"Archivo no válido",text:"Por favor, arrastra archivos GeoJSON (.json o .geojson)",icon:"warning",confirmButtonText:"Aceptar"});return}let x=0,y=0;for(const m of h)try{const E=await m.text(),I=JSON.parse(E);if(!c(I)){v.fire({title:"GeoJSON no válido",text:`El archivo ${m.name} no es un GeoJSON válido`,icon:"error",confirmButtonText:"Aceptar"});continue}const l=i(I);if(l.length===0){v.fire({title:"Sin puntos válidos",text:`El archivo ${m.name} no contiene geometrías tipo Point`,icon:"warning",confirmButtonText:"Aceptar"});continue}f(l,t),x+=l.length,y++}catch(E){console.error(`Error procesando archivo ${m.name}:`,E),v.fire({title:"Error de procesamiento",text:`Error al procesar ${m.name}: ${E.message}`,icon:"error",confirmButtonText:"Aceptar"})}if(y>0){v.fire({title:"Carga completada",text:`Se cargaron ${x} puntos desde ${y} archivo(s)`,icon:"success",confirmButtonText:"Aceptar"});const m=t.layer.getSource();if(m.getFeatures().length>0){const I=m.getExtent();e.getView().fit(I,{duration:800,maxZoom:17,padding:[40,40,40,40]})}}});function c(s){return s&&typeof s=="object"&&s.type&&(s.type==="FeatureCollection"||s.type==="Feature"||s.type==="Point")}function i(s){const p=[];return s.type==="FeatureCollection"?s.features.forEach(h=>{h.geometry&&h.geometry.type==="Point"&&p.push(h)}):s.type==="Feature"&&s.geometry&&s.geometry.type==="Point"?p.push(s):s.type==="Point"&&p.push({type:"Feature",geometry:s,properties:{}}),p}function f(s,p){for(const h of s)try{const x=h.geometry.coordinates,y=h.properties||{},m=y.id||y.name||`dragdrop_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,E=y.name||y.id||"Punto importado",I=y.userId||y.user||y.name||"imported",l={x:x[0],y:x[1],id:m,name:E,userId:I,fleet:y.fleet||"dragdrop"};p.addFeature(l)}catch(x){console.error("Error procesando feature:",x)}}return{layer:t.layer,clearFeatures:()=>t.clearFeatures()}};export{Bt as a,Dt as c};
