var e=Object.defineProperty,t=(t,o,r)=>((t,o,r)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[o]=r)(t,"symbol"!=typeof o?o+"":o,r);import{ao as o,an as r,aG as a,aN as n,a8 as i}from"./maps-BlyNy95n.js";import{G as s,a as c,b as d,g as l,T as u,c as f}from"./core-components-BIXT9T2_.js";import{P as h}from"./utils-BjG0z9UU.js";import{b as p,a as m}from"./ui-DXU7C635.js";const g=m(p());let v;function y(){return new Promise((e,t)=>{const o=indexedDB.open("AvatarDB",1);o.onupgradeneeded=function(e){v=e.target.result,v.objectStoreNames.contains("avatars")||v.createObjectStore("avatars",{keyPath:"id"})},o.onsuccess=function(t){v=t.target.result,e(v)},o.onerror=function(e){t(`Error al abrir IndexedDB: ${e.target.errorCode}`)}})}function b(e){return new Promise((t,o)=>{const r=v.transaction(["avatars"],"readwrite").objectStore("avatars").put(e);r.onsuccess=function(){t("Avatar guardado/actualizado en IndexedDB")},r.onerror=function(e){o(`Error al guardar el avatar: ${e.target.errorCode}`)}})}function E(e){return new Promise((t,o)=>{if(!v)return void o("IndexedDB is not initialized");const r=v.transaction(["avatars"],"readonly").objectStore("avatars").get(e);r.onsuccess=function(e){t(e.target.result)},r.onerror=function(e){o(`Error al obtener el avatar: ${e.target.errorCode}`)}})}function I(){return new Promise((e,t)=>{if(!v)return void t("IndexedDB is not initialized");const o=v.transaction(["avatars"],"readonly").objectStore("avatars").getAll();o.onsuccess=function(t){e(t.target.result)},o.onerror=function(e){t(`Error al obtener los avatares: ${e.target.errorCode}`)}})}const w=class e{constructor(t,o,r,a,n,i=null,s=Date.now(),c=[]){this.id=t,this.coordinates=o,this.fleet=r,this.avatar=a,this.userId=n,this.previousCoordinates=i,this.direction=this.calculateDirection(),this.speed=this.calculateSpeed(),this.lastTimeUpdate=s,this.history=c.length?c:[{coordinates:[...o],timestamp:s}],this.history.length>e.HISTORY_LIMIT&&(this.history=this.history.slice(-1e3))}calculateDirection(){if(!this.previousCoordinates)return{dx:0,dy:0};const e=this.coordinates[1]*Math.PI/180,t=this.coordinates[0]*Math.PI/180,o=this.previousCoordinates[1]*Math.PI/180,r=6371e3,a=o-e;return{dx:r*(this.previousCoordinates[0]*Math.PI/180-t)*Math.cos((e+o)/2),dy:r*a}}calculateSpeed(){if(!this.previousCoordinates)return 0;const e=this.coordinates[1]*Math.PI/180,t=this.coordinates[0]*Math.PI/180,o=this.previousCoordinates[1]*Math.PI/180,r=o-e,a=this.previousCoordinates[0]*Math.PI/180-t,n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e)*Math.cos(o)*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))}updateCoordinates(t){this.calculateDistance(t)>=e.MIN_ADVANCE_DISTANCE&&(this.previousCoordinates=[...this.coordinates],this.coordinates=t,this.direction=this.calculateDirection(),this.speed=this.calculateSpeed(),this.lastTimeUpdate=Date.now(),this.history.push({coordinates:[...t],timestamp:this.lastTimeUpdate}),this.history.length>e.HISTORY_LIMIT&&(this.history=this.history.slice(-1e3)))}setHistory(t){Array.isArray(t)&&(t.length>e.HISTORY_LIMIT?this.history=t.slice(-1e3):this.history=t)}calculateDistance(e){const t=this.coordinates[1]*Math.PI/180,o=this.coordinates[0]*Math.PI/180,r=e[1]*Math.PI/180,a=r-t,n=e[0]*Math.PI/180-o,i=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t)*Math.cos(r)*Math.sin(n/2)*Math.sin(n/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}};t(w,"HISTORY_LIMIT",1e3),t(w,"MIN_ADVANCE_DISTANCE",5);let x=w;async function C(e){await y();const t=await E(e);if(t)return new x(t.id,t.coordinates,t.fleet,t.avatar,t.userId,t.previousCoordinates,t.lastTimeUpdate,t.history||[]);throw new Error(`Avatar with ID ${e} not found`)}function S(){return new Promise((e,t)=>{if(!v)return void t("IndexedDB is not initialized");const o=v.transaction(["avatars"],"readwrite").objectStore("avatars").clear();o.onsuccess=function(){e("All avatars deleted from IndexedDB")},o.onerror=function(e){t(`Error clearing avatars: ${e.target.errorCode}`)}})}async function M(e){await y(),setInterval(async()=>{try{const t=await I(),o=Date.now();e.innerHTML="",t.forEach(t=>{const r=document.createElement("avatar-component");r.setAttribute("img-src",t.avatar),r.setAttribute("title",t.userId),r.setAttribute("subtitle",function(e,t){const o=Math.abs(t-e),r=Math.floor(o/864e5),a=Math.floor(o%864e5/36e5),n=Math.floor(o%36e5/6e4),i=Math.floor(o%6e4/1e3);return`${r}d ${a}h ${n}m ${i}s`}(t.lastTimeUpdate,o)),r.setAttribute("id",t.id),e.appendChild(r)})}catch(t){console.error("Error creating item container:",t)}},3e3)}const B=e=>{if(console.log("Componente SSE version: ","v2.0.0"),console.log("load componente SSE: ",""),document.title="Sistema de Monitoreo en Tiempo Real",!e)return void console.error("No se recibió una instancia de mapa válida");!function(){const e=document.getElementById("avatarContainer"),t=document.getElementById("avatarContainerList");e&&t?(console.log("Avatar container encontrado, inicializando..."),M(t)):(console.error("Avatar container no encontrado"),function(){if(document.getElementById("avatarContainer"))return;const e='\n            <side-panel id="avatarContainer">\n                <div id="db-actions" style="padding-bottom: 8px; display: flex; gap: 8px; border-bottom: 1px solid #aaa; justify-content: space-between;">\n                    <button id="exportBtn">Exportar BD</button>\n                    <button id="importBtn">Importar BD</button>\n                    <input type="file" id="importInput" accept="application/json" style="display:none;">\n                </div>\n                <div id="avatarContainerList"></div>\n            </side-panel>\n        ';document.body.insertAdjacentHTML("beforeend",e);const t=document.getElementById("avatarContainerList");t&&M(t)}())}(),function(){const e=localStorage.getItem("avatar_coords_init");if(e)try{const t=JSON.parse(e);if(Array.isArray(t)&&t.length>=2){const e={longitud:t[0],latitud:t[1],zoom:12};h.publish("initialView",e)}}catch(o){console.error("Error parsing avatar_coords_init from localStorage:",o)}const t=document.getElementById("avatarContainerList");t&&M(t)}();const t=new s(e,{title:"avatares"}),f=new c(e,{title:"geofences"}),p=new d(e,{title:"historicos"});let m=l(e,"SSE");m.getLayers().push(t.layer),m.getLayers().push(f.layer),m.getLayers().push(p.layer),f.setSource("/geofences/get");const w=new EventSource("/sse");w.onmessage=function(e){const o=JSON.parse(e.data);let r={},a={};switch(o.command){case"set":console.log(`Hook Event: ${JSON.stringify(o)}`),r=f.mapGeoFences[o.hook],null!=r&&("enter"==o.detect||"cross"==o.detect?(f.incrementUserCount(o.hook),r.setStyle(f.getStyleByHook("enter"))):(f.decrementUserCount(o.hook),0==f.getFeatureCount(o.hook)&&r.setStyle(f.getStyleByHook("default"))));C(o.id).then(e=>{o.userId=e.userId,function(e){let t={...e},o="right",r="#00b09b",a="#96c93d",n=D(r,a);switch(t.detect){case"enter":t.detect="Entró",o="left";break;case"exit":t.detect="Salió",o="left",r="#ff5f6d",a="#ffc371",n=D(r,a);break;case"cross":t.detect="Cruzó",o="left";break;default:t.detect="Desconocido"}u({text:`${t.userId} - ${t.detect} - ${t.hook}`,duration:15e3,close:!0,gravity:"bottom",position:o,style:{background:n,position:"absolute",zIndex:"1000"}}).showToast()}(o)}).catch(e=>{console.error("Error retrieving avatar:",e)});break;case"avatar":if(a=o.data,t.clearFeatures(),null==a)return;a.forEach(e=>{const o="avatar_coords_init";if(!localStorage.getItem(o)){localStorage.setItem(o,JSON.stringify(e.object.coordinates));const t=e.object.coordinates;if(Array.isArray(t)&&t.length>=2){const e={longitud:t[0],latitud:t[1],zoom:12};h.publish("initialView",e)}}const r=T(e,"fleet")+1,a=T(e,"icon")+1,n=T(e,"user_id")+1;let i={};i.x=e.object.coordinates[0],i.y=e.object.coordinates[1],i.uniqueid=e.id;const s=0!==r&&void 0!==e.fields[r]?e.fields[r]:"avatar",c=0!==a&&void 0!==e.fields[a]?e.fields[a]:"assets/hacker.png",d=0!==n&&void 0!==e.fields[n]?e.fields[n]:"unknown";i.fleet=s,i.avatar=c,i.userId=d,t.addFeature(i);(async function(e,t){await y();const o=await E(e);if(o){const e=new x(o.id,o.coordinates,o.fleet,o.avatar,o.userId,o.previousCoordinates,o.lastTimeUpdate,o.history||[]);e.updateCoordinates(t.coordinates),await b(e)}else{const o=new x(e,t.coordinates,t.fleet,t.avatar,t.userId,null,Date.now(),[]);await b(o)}})(e.id,{id:e.id,coordinates:e.object.coordinates,fleet:s,avatar:c,userId:d}).then(()=>{}).catch(e=>{console.error("Error adding or updating avatar:",e)})});break;case"del":console.log(`Del Event: ${JSON.stringify(o)}`);break;default:console.log(JSON.stringify(o))}},w.onerror=function(e){console.error("SSE Error:",e)},window.addEventListener("beforeunload",function(){w.close()}),document.addEventListener("avatar-click",e=>{C(e.detail.id).then(e=>{console.log(e);const t=Date.now();Math.abs(e.lastTimeUpdate-t);const n=new o({geometry:new r(a(e.coordinates)),unique_id:e.id,fleet:e.fleet,avatar:e.avatar,userId:e.userId});h.publish("featureSelected",n)}).catch(e=>{console.error("Error retrieving avatar:",e)})}),document.addEventListener("clear-click",e=>{const t=e.detail.id;var o;(o=t,new Promise((e,t)=>{if(!v)return void t("IndexedDB is not initialized");const r=v.transaction(["avatars"],"readwrite").objectStore("avatars").delete(o);r.onsuccess=function(){e(`Avatar with ID ${o} deleted from IndexedDB`)},r.onerror=function(e){t(`Error deleting avatar: ${e.target.errorCode}`)}})).then(()=>{console.log(`Avatar with ID ${t} deleted from IndexedDB`)}).catch(e=>{console.error("Error deleting avatar:",e)})}),document.addEventListener("avatar-history-click",t=>{C(t.detail.id).then(t=>{if(p.clearFeatures(),t.history&&t.history.length>1){p.addTrajectory(t.history,"#3C64E9");const o=p.layer.getSource();if(o.getFeatures().length>0){const t=o.getExtent();e.getView().fit(t,{duration:800,maxZoom:17,padding:[45,45,45,45]})}}else g.fire({title:"No hay historial disponible",text:"Este avatar no tiene historial de ubicaciones.",icon:"info",confirmButtonText:"Aceptar"})}).catch(e=>{console.error("Error retrieving avatar history:",e)})});const B=function(e,t){let o=null;return function(...r){o&&clearTimeout(o),o=setTimeout(()=>e.apply(this,r),t)}}(()=>{g.fire({title:"¿Estás seguro?",text:"Esta acción eliminará todos los avatares de la base de datos.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&S().then(()=>{console.log("All avatars deleted from IndexedDB"),t.clearFeatures(),g.fire("¡Eliminado!","La base de datos ha sido borrada.","success")}).catch(e=>{console.error("Error clearing avatars:",e),g.fire("Error","No se pudo borrar la base de datos.","error")})})},500);document.addEventListener("flushdb-click",B);const A=document.getElementById("exportBtn");A&&A.addEventListener("click",async()=>{if((await g.fire({title:"¿Exportar la base de datos?",text:"Esto descargará todos los avatares en un archivo JSON.",icon:"question",showCancelButton:!0,confirmButtonText:"Exportar",cancelButtonText:"Cancelar"})).isConfirmed){await y();const e=await I(),t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="avatars_export.json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),g.fire("Exportado","Archivo exportado correctamente.","success")}});const k=document.getElementById("importBtn");k&&k.addEventListener("click",async()=>{if((await g.fire({title:"¿Importar base de datos?",text:"Esto puede sobrescribir los avatares actuales. ¿Desea continuar?",icon:"warning",showCancelButton:!0,confirmButtonText:"Importar",cancelButtonText:"Cancelar"})).isConfirmed){const e=document.getElementById("importInput");e&&e.click()}});const L=document.getElementById("importInput");L&&L.addEventListener("change",async e=>{const t=e.target.files[0];if(t)try{const e=await t.text(),o=JSON.parse(e);if(Array.isArray(o)){await y(),await S();for(const e of o)await b(e);g.fire("Importado","Base de datos importada correctamente.","success")}else g.fire("Error","El archivo no contiene un array válido.","error")}catch(o){g.fire("Error","No se pudo importar el archivo: "+o,"error")}}),e.on("click",function(o){e.forEachFeatureAtPixel(o.pixel,function(e,o){if(o===t.layer||o===f.layer){let r=e.getProperties();delete r.geometry,r.layerName=o.get("title"),h.publish("feedbackParent",{type:"sseEventClicked",body:r}),o===f.layer&&(console.log("Geofence clicked:",r),u({text:`Geofence clicked: ${r.hook}`,duration:3e3,close:!0,gravity:"top",position:"center",style:{background:D("#00b09b","#96c93d"),position:"absolute",zIndex:"1000"}}).showToast()),o===t.layer&&C(r.unique_id).then(e=>{const t=`${e.coordinates[1]},${e.coordinates[0]}`;navigator.clipboard.writeText(t).then(function(){console.log("Coordinates copied to clipboard:",t),u({text:`Coordenadas copiadas: ${t}`,duration:3e3,close:!0,gravity:"top",position:"center",style:{background:D("#00b09b","#96c93d"),position:"absolute",zIndex:"1000"}}).showToast()}).catch(function(e){console.error("Could not copy coordinates:",e)})}).catch(e=>{console.error("Error retrieving avatar:",e)})}})}),e.on("moveend",function(t){const o=e.getView().getCenter();if(o){const[e,t]=n(o);localStorage.setItem("avatar_coords_init",JSON.stringify([e,t]))}});e.addControl(new class extends i{constructor(o={}){const r=document.createElement("button");r.innerHTML="👤",r.title="Centrar en avatares";const a=document.createElement("div");a.className="ol-unselectable ol-control ol-center-avatars",a.style.top="80px",a.style.left="0.5em",a.appendChild(r),super({element:a,target:o.target}),r.addEventListener("click",()=>{const o=t.layer.getSource();if(o){if(o.getFeatures().length>0){const t=o.getExtent();e.getView().fit(t,{duration:800,maxZoom:17,padding:[40,40,40,40]})}}})}})};function D(e,t){return`linear-gradient(to right, ${e}, ${t})`}function T(e,t){return e&&e.fields&&Array.isArray(e.fields)?e.fields.indexOf(t):-1}const A=e=>{if(console.log("Componente DragDrop version: ","v1.0.0"),console.log("Componente DragDrop iniciado"),!e)return void console.error("No se recibió una instancia de mapa válida");const t=new f(e,{title:"tematico"});l(e,"DragDrop").getLayers().push(t.layer);const o=e.getTargetElement();function r(e){return e&&"object"==typeof e&&e.type&&("FeatureCollection"===e.type||"Feature"===e.type||"Point"===e.type)}function a(e){const t=[];return"FeatureCollection"===e.type?e.features.forEach(e=>{e.geometry&&"Point"===e.geometry.type&&t.push(e)}):"Feature"===e.type&&e.geometry&&"Point"===e.geometry.type?t.push(e):"Point"===e.type&&t.push({type:"Feature",geometry:e,properties:{}}),t}function n(e,t){for(const r of e)try{const e=r.geometry.coordinates,o=r.properties||{},a=o.id||o.name||`dragdrop_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n=o.name||o.id||"Punto importado",i=o.userId||o.user||o.name||"imported",s={x:e[0],y:e[1],id:a,name:n,userId:i,fleet:o.fleet||"dragdrop"};t.addFeature(s)}catch(o){console.error("Error procesando feature:",o)}}return o.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",o.style.backgroundColor="rgba(0, 255, 0, 0.1)"}),o.addEventListener("dragleave",e=>{e.preventDefault(),o.style.backgroundColor=""}),o.addEventListener("drop",async i=>{i.preventDefault(),o.style.backgroundColor="";const s=Array.from(i.dataTransfer.files).filter(e=>"application/json"===e.type||e.name.toLowerCase().endsWith(".geojson")||e.name.toLowerCase().endsWith(".json"));if(0===s.length)return void g.fire({title:"Archivo no válido",text:"Por favor, arrastra archivos GeoJSON (.json o .geojson)",icon:"warning",confirmButtonText:"Aceptar"});let c=0,d=0;for(const e of s)try{const o=await e.text(),i=JSON.parse(o);if(!r(i)){g.fire({title:"GeoJSON no válido",text:`El archivo ${e.name} no es un GeoJSON válido`,icon:"error",confirmButtonText:"Aceptar"});continue}const s=a(i);if(0===s.length){g.fire({title:"Sin puntos válidos",text:`El archivo ${e.name} no contiene geometrías tipo Point`,icon:"warning",confirmButtonText:"Aceptar"});continue}n(s,t),c+=s.length,d++}catch(l){console.error(`Error procesando archivo ${e.name}:`,l),g.fire({title:"Error de procesamiento",text:`Error al procesar ${e.name}: ${l.message}`,icon:"error",confirmButtonText:"Aceptar"})}if(d>0){g.fire({title:"Carga completada",text:`Se cargaron ${c} puntos desde ${d} archivo(s)`,icon:"success",confirmButtonText:"Aceptar"});const o=t.layer.getSource();if(o.getFeatures().length>0){const t=o.getExtent();e.getView().fit(t,{duration:800,maxZoom:17,padding:[40,40,40,40]})}}}),{layer:t.layer,clearFeatures:()=>t.clearFeatures()}};export{A as a,B as c};
